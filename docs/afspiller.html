<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Afspiller</title>
  <link id="theme-stylesheet" rel="stylesheet" href="style.css">
</head>
<body>
<div class="container">
  <div id="podcast-info" class="podcast-info"></div>
  <div id="pagination-controls" class="pagination-controls">
    <button id="prev-page" class="pagination-button">←</button>
    <span id="page-info" class="page-info">
      <span id="current-page" contenteditable="true">1</span> / <span id="total-pages">1</span>
    </span>
    <button id="next-page" class="pagination-button">→</button>
    <button id="theme-toggle" class="theme-toggle-button">Toggle Theme</button>
  </div>
</div>

<audio id="audio-player" controls preload="none" style="width: 500px; position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);">
  Din browser understøtter ikke direkte afspilning af lydfiler
</audio>

<script>
document.addEventListener("DOMContentLoaded", () => {
  let currentPage = 1;
  const itemsPerPage = 10;
  const themeStylesheet = document.getElementById("theme-stylesheet");
  const savedTheme = localStorage.getItem('theme') || 'style.css';
  let totalPages = 1;
  let episodesData = [];

  themeStylesheet.setAttribute('href', savedTheme);

  document.getElementById("theme-toggle").addEventListener("click", () => {
    const currentTheme = themeStylesheet.getAttribute("href");
    const newTheme = currentTheme === "style.css" ? "light.css" : "style.css";
    themeStylesheet.setAttribute("href", newTheme);
    localStorage.setItem('theme', newTheme);
  });

  async function loadPodcast() {
    try {
    const params = new URLSearchParams(window.location.search);
          const rssUrl = params.get("rss");
          if (!rssUrl) {
            throw new Error("Ugyldig RSS");
          }
      const response = await fetch(rssUrl);
      if (!response.ok) throw new Error(`Netværksfejl: ${response.statusText}`);
      
      const rssText = await response.text();
      const parser = new DOMParser();
      const rssDoc = parser.parseFromString(rssText, "application/xml");
      
      if (rssDoc.querySelector("parsererror")) throw new Error("Ugyldigt XML-format");
      
      const channel = rssDoc.querySelector("channel");
      if (!channel) throw new Error("Ugyldig RSS: Mangler hovedkanal i feed");
      
      const title = channel.querySelector("title")?.textContent || "(ingen titel)";
      const description = channel.querySelector("description")?.textContent || "(ingen beskrivelse)";
      const episodes = channel.querySelectorAll("item");
      
      episodesData = Array.from(episodes).map((episode) => ({
        title: episode.querySelector("title")?.textContent || "(ingen titel)",
        description: episode.querySelector("description")?.textContent || "(ingen beskrivelse)",
        pubDate: new Date(episode.querySelector("pubDate")?.textContent),
        link: episode.querySelector("enclosure")?.getAttribute("url"),
      }));
      
      document.getElementById("podcast-info").innerHTML = `<h2>${title}</h2><p>${description}</p>`;
      totalPages = Math.ceil(episodesData.length / itemsPerPage);
      document.getElementById("total-pages").textContent = totalPages;
      displayEpisodes();
    } catch (error) {
      document.getElementById("podcast-info").innerHTML = `<p>Indlæsningsfejl: ${error.message}</p>`;
      console.error("Error loading podcast data:", error);
    }
  }

  function displayEpisodes() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    episodesData.sort((a, b) => new Date(a.pubDate) - new Date(b.pubDate));
    const episodesToShow = episodesData.slice(startIndex, endIndex);
    let episodesHTML = '';
    
    episodesToShow.forEach((episode) => {
      episodesHTML += `
        <div class="episode" data-url="${episode.link}" data-title="${episode.title.replace(/'/g, "\\'")}">
          <h4 class="episode-title">${episode.title}</h4>
          <p class="pub-date">${episode.pubDate.toLocaleDateString()}</p>
          <p class="episode-description">${episode.description}</p>
        </div>
      `;
    });

    document.getElementById("podcast-info").innerHTML += episodesHTML;
    attachEpisodeClickListeners();
    attachDescriptionToggleListeners();
    updatePaginationControls();
  }

  function attachEpisodeClickListeners() {
    document.querySelectorAll('.episode').forEach((episodeElement) => {
      episodeElement.addEventListener('click', (event) => {
        if (!event.target.classList.contains('episode-description')) {
          const episodeUrl = episodeElement.getAttribute('data-url');
          const episodeTitle = episodeElement.getAttribute('data-title');
          playEpisode(episodeUrl, episodeTitle);
        }
      });
    });
  }

  function attachDescriptionToggleListeners() {
    document.querySelectorAll('.episode-description').forEach((description) => {
      description.addEventListener('click', (event) => {
        event.stopPropagation();
        if (description.style.maxHeight) {
          description.style.maxHeight = null;
          description.classList.remove('expanded');
        } else {
          description.style.maxHeight = description.scrollHeight + "px";
          description.classList.add('expanded');
        }
      });
    });
  }

  function updatePaginationControls() {
    document.getElementById("current-page").textContent = currentPage;
    document.getElementById("prev-page").disabled = currentPage === 1;
    document.getElementById("next-page").disabled = currentPage === totalPages;
  }

  function changePage(increment) {
    currentPage += increment;
    document.querySelectorAll('.episode').forEach(episode => episode.remove());
    displayEpisodes();
  }

  function playEpisode(episodeUrl, episodeTitle) {
    const audioPlayer = document.getElementById("audio-player");
    audioPlayer.src = episodeUrl;
    audioPlayer.style.display = "block";
    audioPlayer.play();
    document.title = episodeTitle;
  }

  document.getElementById("page-info").addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
      const newPage = parseInt(document.getElementById("current-page").textContent);
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        document.querySelectorAll('.episode').forEach(episode => episode.remove());
        displayEpisodes();
      } else {
        document.getElementById("current-page").textContent = currentPage;
      }
      event.target.blur();
    }
  });

  document.getElementById("prev-page").addEventListener('click', () => changePage(-1));
  document.getElementById("next-page").addEventListener('click', () => changePage(1));

  loadPodcast();
});

</script>
</body>
</html>
